<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iam-bangali Blog</title>
<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: #000;
    color: white;
    text-align: center;
  }
  h1 {
    color: #ff007f;
    margin-top: 20px;
  }
  .container {
    max-width: 600px;
    margin: auto;
  }
  input, textarea {
    width: 90%;
    margin: 8px;
    padding: 10px;
    border: 1px solid #ff007f;
    border-radius: 5px;
    background: #111;
    color: white;
  }
  button {
    background: #ff007f;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    color: white;
    font-weight: bold;
  }
  button:hover {
    opacity: 0.8;
  }
  .post {
    border: 1px solid #ff007f;
    margin: 10px;
    padding: 10px;
    border-radius: 10px;
    background: #111;
    text-align: left;
  }
  .author {
    font-size: 14px;
    color: #ccc;
  }
  .verified-blue {
    color: #00b3ff;
  }
  .verified-black {
    color: #888;
  }

  /* ===== Custom Delete Confirm Modal ===== */
  #confirmModal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
    z-index: 999;
  }
  .modal-content {
    background: #111;
    border: 1px solid #ff007f;
    border-radius: 10px;
    padding: 25px;
    text-align: center;
    width: 80%;
    max-width: 300px;
    box-shadow: 0 0 20px #ff007f55;
  }
  .modal-content h3 {
    color: #ff007f;
    margin-bottom: 15px;
  }
  .modal-buttons {
    display: flex;
    justify-content: space-around;
  }
  .modal-buttons button {
    width: 100px;
  }
  .cancel-btn {
    background: #333;
  }
  .ok-btn {
    background: #ff007f;
  }
</style>
</head>
<body>

<h1>üî• iam-bangali Blog</h1>
<p>Powered by Firebase</p>

<div id="authSection" class="container">
  <h2>Login to post</h2>
  <input type="email" id="email" placeholder="Enter any email">
  <input type="password" id="password" placeholder="Enter any password">
  <button onclick="login()">Login</button>
</div>

<div id="postSection" class="container" style="display:none;">
  <h2>Create Post</h2>
  <textarea id="postContent" placeholder="Write something..."></textarea>
  <button onclick="addPost()">Post</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="postsContainer" class="container"></div>

<!-- Custom Delete Confirm Modal -->
<div id="confirmModal">
  <div class="modal-content">
    <h3>üóë Delete this post?</h3>
    <div class="modal-buttons">
      <button class="cancel-btn" onclick="closeConfirm()">Cancel</button>
      <button class="ok-btn" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
  import { getDatabase, ref, push, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBJDxMljBYj-P2O-JqGuD4ZTW_BqA9dvkY",
    authDomain: "csm-bolg-site.firebaseapp.com",
    databaseURL: "https://csm-bolg-site-default-rtdb.firebaseio.com",
    projectId: "csm-bolg-site",
    storageBucket: "csm-bolg-site.appspot.com",
    messagingSenderId: "917499515",
    appId: "1:917499515:web:dc9890e7e990e55d7e66de",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  const adminEmail = "csm.mohasin@gmail.com";

  const authSection = document.getElementById("authSection");
  const postSection = document.getElementById("postSection");
  const postsContainer = document.getElementById("postsContainer");
  const confirmModal = document.getElementById("confirmModal");
  let postToDelete = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      authSection.style.display = "none";
      postSection.style.display = "block";
      loadPosts(user.email);
    } else {
      authSection.style.display = "block";
      postSection.style.display = "none";
      loadPosts();
    }
  });

  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value || "guest123";

    try {
      await signInWithEmailAndPassword(auth, email, password);
      alert("Login successful!");
    } catch (error) {
      try {
        await createUserWithEmailAndPassword(auth, email, password);
        alert("New user created successfully!");
      } catch (e) {
        alert("Login Failed: " + e.message);
      }
    }
  }

  function logout() {
    signOut(auth);
  }

  function addPost() {
    const content = document.getElementById("postContent").value.trim();
    if (!content) return alert("Please write something!");

    const user = auth.currentUser;
    if (!user) return alert("Login first!");

    const name = user.email === adminEmail 
      ? "CSM Mohasin Alam"
      : user.email.split("@")[0];

    const verifiedClass = user.email === adminEmail ? "verified-blue" : "verified-black";
    const newPostRef = push(ref(db, "posts"));
    set(newPostRef, {
      author: name,
      email: user.email,
      verified: verifiedClass,
      content: content,
      timestamp: Date.now()
    });
    document.getElementById("postContent").value = "";
  }

  function loadPosts(currentEmail = null) {
    onValue(ref(db, "posts"), (snapshot) => {
      const data = snapshot.val();
      postsContainer.innerHTML = "";

      if (data) {
        const posts = Object.entries(data).sort((a, b) => b[1].timestamp - a[1].timestamp);
        posts.forEach(([id, post]) => {
          const canEdit = currentEmail === adminEmail;
          const postDiv = document.createElement("div");
          postDiv.className = "post";
          postDiv.innerHTML = `
            <p>${post.content}</p>
            <p class="author">‚úçÔ∏è ${post.author} <span class="${post.verified}">‚úî</span></p>
            ${canEdit ? `
              <button onclick="editPost('${id}', '${post.content}')">Edit</button>
              <button onclick="openConfirm('${id}')">Delete</button>
            ` : ""}
          `;
          postsContainer.appendChild(postDiv);
        });
      }
    });
  }

  // ===== Custom Confirm Modal Functions =====
  window.openConfirm = function(id) {
    postToDelete = id;
    confirmModal.style.display = "flex";
  };

  window.closeConfirm = function() {
    postToDelete = null;
    confirmModal.style.display = "none";
  };

  window.confirmDelete = function() {
    if (postToDelete) {
      remove(ref(db, "posts/" + postToDelete));
      postToDelete = null;
      confirmModal.style.display = "none";
    }
  };

  window.editPost = function(id, oldContent) {
    const newContent = prompt("Edit your post:", oldContent);
    if (newContent && newContent !== oldContent) {
      update(ref(db, "posts/" + id), { content: newContent });
    }
  };
</script>
</body>
</html>
