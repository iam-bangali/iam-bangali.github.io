<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CSM Messenger - Global Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
  body { background: #0f0f0f; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .chat-container {
    width: 100%; max-width: 600px; height: 90vh;
    background: #1a1a1a; border-radius: 20px;
    display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 0 20px #00bcd4;
  }
  .header { background: #101010; padding: 10px; text-align: center; border-bottom: 2px solid #00bcd4; font-weight: 600; font-size: 1.2rem; color: #00bcd4; }
  .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; }
  .message { margin-bottom: 12px; max-width: 80%; padding: 10px 14px; border-radius: 15px; word-wrap: break-word; }
  .message.admin { background: linear-gradient(135deg, #00bcd4, #007bff); align-self: flex-end; }
  .message.user { background: #333; align-self: flex-start; }
  .message span.name { display: block; font-size: 0.85rem; margin-bottom: 5px; opacity: 0.8; }
  .message img.verified { width: 16px; height: 16px; vertical-align: middle; margin-left: 5px; border-radius: 50%; }
  .typing { font-size: 0.9rem; color: #888; margin: 5px 15px; }
  .input-area { display: flex; border-top: 2px solid #00bcd4; }
  .input-area input { flex: 1; padding: 10px; background: #222; color: white; border: none; outline: none; }
  .input-area button { background: #00bcd4; color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; }
  .seen { font-size: 0.7rem; color: #aaa; text-align: right; margin-top: 2px; }
</style>
</head>
<body>

<div class="chat-container">
  <div class="header">ðŸ’¬ CSM Messenger - Global Chat</div>
  <div class="messages" id="messages"></div>
  <div class="typing" id="typing"></div>
  <div class="input-area">
    <input type="text" id="msgInput" placeholder="Type a message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAeC_qcXhUeXBeGDSPr-ODJMWnG8ykD5B4",
    authDomain: "csm-bolg-site.firebaseapp.com",
    databaseURL: "https://csm-bolg-site-default-rtdb.firebaseio.com",
    projectId: "csm-bolg-site",
    storageBucket: "csm-bolg-site.firebasestorage.app",
    messagingSenderId: "931917499515",
    appId: "1:931917499515:web:dc9890e7e990e55d7e66de",
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const messaging = firebase.messaging();

  const adminEmail = "csmmohasinalam@gmail.com";
  const adminVerifiedImg = "https://dl8.wapkizfile.info/download/c4275ed00b49e8d2f586ffbd4dc6c25f/csm-mohasin-alam+wapkizs+com/2-jpg-(csm-mohasin-alam.wapkizs.com).jpg";

  const userEmail = prompt("Enter your email:");
  const userName = userEmail === adminEmail ? "Csm Mohasin Alam" : "Guest_" + Math.floor(Math.random() * 1000);
  const isAdmin = userEmail === adminEmail;

  const sendBtn = document.getElementById("sendBtn");
  const msgInput = document.getElementById("msgInput");
  const messagesDiv = document.getElementById("messages");
  const typingDiv = document.getElementById("typing");

  msgInput.addEventListener("input", () => {
    db.ref("typing").set(userName);
    setTimeout(() => db.ref("typing").remove(), 2000);
  });

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;
    const msgData = { name: userName, text, isAdmin, timestamp: Date.now() };
    db.ref("messages").push(msgData);
    msgInput.value = "";

    // à¦¯à¦¦à¦¿ guest à¦ªà¦¾à¦ à¦¾à¦¯à¦¼ â†’ admin à¦•à§‡ à¦¨à§‹à¦Ÿà¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨ à¦ªà¦¾à¦ à¦¾à¦“
    if (!isAdmin) {
      sendAdminNotification(userName, text);
    }
  }

  function sendAdminNotification(sender, text) {
    if ("Notification" in window) {
      Notification.requestPermission().then(permission => {
        if (permission === "granted") {
          new Notification(`New message from ${sender}`, {
            body: text,
            icon: "https://cdn-icons-png.flaticon.com/512/10308/10308648.png"
          });
        }
      });
    }
  }

  db.ref("messages").on("value", snap => {
    const data = snap.val();
    messagesDiv.innerHTML = "";
    if (!data) return;
    Object.values(data).sort((a, b) => a.timestamp - b.timestamp).forEach(msg => {
      const div = document.createElement("div");
      div.classList.add("message", msg.isAdmin ? "admin" : "user");
      div.innerHTML = `
        <span class="name">${msg.name}
          ${msg.isAdmin ? `<img src="${adminVerifiedImg}" class="verified"/>` : ""}
        </span>${msg.text}
        ${msg.isAdmin ? `<div class="seen">âœ” Seen by all</div>` : ""}
      `;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  });

  db.ref("typing").on("value", snap => {
    const typer = snap.val();
    typingDiv.textContent = typer && typer !== userName ? `${typer} is typing...` : "";
  });

  // ðŸ”” Firebase push notification setup (for Admin device)
  if (isAdmin && "serviceWorker" in navigator) {
    navigator.serviceWorker.register("firebase-messaging-sw.js").then(reg => {
      messaging.getToken({ vapidKey: "BGcWwsZX4QgaUQQ8NNZOHJUktYIIq5bx7W_vLULr_U6XH1BAZddxhfIGDglmAbGwgkze_shZF9Q5ts8fA4Ysztg", serviceWorkerRegistration: reg })
        .then(token => console.log("Admin notification token:", token))
        .catch(err => console.error(err));
    });
  }
</script>

</body>
</html>
